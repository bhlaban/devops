{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "domainName": {
      "type": "string",
      "metadata": {
        "description": "The fully qualified name of the AD domain to create"
      },
      "defaultValue": "seicdevops.local"
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the administrator account to create"
      },
      "defaultValue": "superuser"
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the Administrator account"
      }
    },
    "compileDateTime": {
      "type": "string",
      "metadata": {
        "description": "A date/time string used to make DSC config compilation names unique (i.e. '06-20-2018 10:45:00 AM')"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
      },
      "defaultValue": "https://raw.githubusercontent.com/bhlaban/devops/master/"
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
      },
      "defaultValue": ""
    }
  },
  "variables": {
    "automationAccountName": "automation",
    "vnetName": "vnet",
    "managementSubnetName": "management-subnet",
    "directorySubnetName": "directory-subnet",
    "applicationSubnetName": "application-subnet",
    "dataSubnetName": "data-subnet",
    "jumpBoxVmName": "jumpbox01",
    "jumpBoxVmSize": "Standard_D4_v3",
    "jumpBoxConfigName": "JumpBoxConfig",
    "jumpBoxNodeConfigName": "[concat(variables('jumpBoxConfigName'), '.localhost']",
    "dcIpAddress": "10.0.1.10",
    "dcVmName": "dc01",
    "dcVmSize": "Standard_D4_v3",
    "dcConfigName": "DomainControllerConfig",
    "dcNodeConfigName": "[concat(variables('dcConfigName'), '.localhost']",
    "sqlServerIpAddress": "10.0.3.10",
    "sqlServerVmName": "sqlserver01",
    "sqlServerVmSize": "Standard_D4_v3",
    "sqlServerConfigName": "SqlServerConfig",
    "sqlServerNodeConfigName": "[concat(variables('sqlServerConfigName'), '.localhosts']",
    "jamaIpAddress": "10.0.2.10",
    "jamaVmName": "jama01",
    "jamaVmSize": "Standard_D4_v3",
    "tfsIpAddress": "10.0.2.20",
    "tfsVmName": "tfs01",
    "tfsVmSize": "Standard_D4_v3",
    "tfsConfigName": "TfsConfig",
    "tfsNodeConfigName": "[concat(variables('tfsConfigName'), '.localhost']",
    "templates": {
      "automationAccountTemplate": "[uri(parameters('_artifactsLocation'), concat('templates/automationAccount.json', parameters('_artifactsLocationSasToken')))]",
      "networkTemplate": "[uri(parameters('_artifactsLocation'), concat('templates/virtualNetwork.json', parameters('_artifactsLocationSasToken')))]",
      "domainControllerTemplate": "[uri(parameters('_artifactsLocation'), concat('templates/domainController.json', parameters('_artifactsLocationSasToken')))]",
      "jumpBoxTemplate": "[uri(parameters('_artifactsLocation'), concat('templates/jumpBox.json', parameters('_artifactsLocationSasToken')))]",
      "sqlServerTemplate": "[uri(parameters('_artifactsLocation'), concat('templates/sqlServer.json', parameters('_artifactsLocationSasToken')))]",
      "jamaTemplate": "[uri(parameters('_artifactsLocation'), concat('templates/jama.json', parameters('_artifactsLocationSasToken')))]",
      "tfsTemplate": "[uri(parameters('_artifactsLocation'), concat('templates/tfs.json', parameters('_artifactsLocationSasToken')))]"
    }
  },
  "resources": [
    {
      "name": "AutomationAccount",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templates').automationAccountTemplate]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "automationAccountName": {
            "value": "[variables('automationAccountName')]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "dcConfigName": {
            "value": "[variables('dcConfigName')]"
          },
          "jumpBoxConfigName": {
            "value": "[variables('jumpBoxConfigName')]"
          },
          "sqlServerConfigName": {
            "value": "[variables('sqlServerConfigName')]"
          },
          "tfsConfigName": {
            "value": "[variables('tfsConfigName')]"
          },
          "compileDateTime": {
            "value": "[parameters('compileDateTime')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "name": "Network",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "comments": "This creates the virtual network and subnets",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templates').networkTemplate]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vnetName": {
            "value": "[variables('vnetName')]"
          },
          "managementSubnetName": {
            "value": "[variables('managementSubnetName')]"
          },
          "directorySubnetName": {
            "value": "[variables('directorySubnetName')]"
          },
          "applicationSubnetName": {
            "value": "[variables('applicationSubnetName')]"
          },
          "dataSubnetName": {
            "value": "[variables('dataSubnetName')]"
          },
          "dnsServers": {
            "value": [
              "[variables('dcIpAddress')]",
              "8.8.8.8"
            ]
          }
        }
      }
    },
    {
      "name": "DomainController",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "comments": "This creates the Domain Controller VM",
      "dependsOn": [
        "Microsoft.Resources/deployments/AutomationAccount",
        "Microsoft.Resources/deployments/Network"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templates').domainControllerTemplate]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vmName": {
            "value": "[variables('dcVmName')]"
          },
          "vmSize": {
            "value": "[variables('dcVmSize')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ipAddress": {
            "value": "[variables('dcIpAddress')]"
          },
          "existingVnetName": {
            "value": "[variables('vnetName')]"
          },
          "existingSubnetName": {
            "value": "[variables('directorySubnetName')]"
          },
          "automationAccountName": {
            "value": "[variables('automationAccountName')]"
          },
          "nodeConfigName": {
            "value": "[variables('dcNodeConfigName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "name": "JumpBox",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "comments": "This creates the JumpBox VM",
      "dependsOn": [
        "Microsoft.Resources/deployments/DomainController"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templates').jumpBoxTemplate]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vmName": {
            "value": "[variables('jumpBoxVmName')]"
          },
          "vmSize": {
            "value": "[variables('jumpBoxVmSize')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "existingVnetName": {
            "value": "[variables('vnetName')]"
          },
          "existingSubnetName": {
            "value": "[variables('managementSubnetName')]"
          },
          "automationAccountName": {
            "value": "[variables('automationAccountName')]"
          },
          "nodeConfigName": {
            "value": "[variables('jumpBoxNodeConfigName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "name": "SQLServer",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "comments": "This creates the SQL Server VM",
      "dependsOn": [
        "Microsoft.Resources/deployments/DomainController"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templates').sqlServerTemplate]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vmName": {
            "value": "[variables('sqlServerVmName')]"
          },
          "vmSize": {
            "value": "[variables('sqlServerVmSize')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ipAddress": {
            "value": "[variables('sqlServerIpAddress')]"
          },
          "existingVnetName": {
            "value": "[variables('vnetName')]"
          },
          "existingSubnetName": {
            "value": "[variables('dataSubnetName')]"
          },
          "automationAccountName": {
            "value": "[variables('automationAccountName')]"
          },
          "nodeConfigName": {
            "value": "[variables('sqlServerNodeConfigName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "name": "Jama",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "comments": "This creates the Jama VM",
      "dependsOn": [
        "Microsoft.Resources/deployments/DomainController"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templates').jamaTemplate]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vmName": {
            "value": "[variables('jamaVmName')]"
          },
          "vmSize": {
            "value": "[variables('jamaVmSize')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ipAddress": {
            "value": "[variables('jamaIpAddress')]"
          },
          "existingVnetName": {
            "value": "[variables('vnetName')]"
          },
          "existingSubnetName": {
            "value": "[variables('applicationSubnetName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "name": "TFS",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "comments": "This creates the TFS VM",
      "dependsOn": [
        "Microsoft.Resources/deployments/DomainController"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templates').tfsTemplate]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vmName": {
            "value": "[variables('tfsVmName')]"
          },
          "vmSize": {
            "value": "[variables('tfsVmSize')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "ipAddress": {
            "value": "[variables('tfsIpAddress')]"
          },
          "existingVnetName": {
            "value": "[variables('vnetName')]"
          },
          "existingSubnetName": {
            "value": "[variables('applicationSubnetName')]"
          },
          "automationAccountName": {
            "value": "[variables('automationAccountName')]"
          },
          "nodeConfigName": {
            "value": "[variables('tfsNodeConfigName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    }
  ]
}